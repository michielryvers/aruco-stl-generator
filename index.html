<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ArUco 3D STL Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
      import * as THREE from "https://unpkg.com/three@0.176.0/build/three.module.js";
      import { STLExporter } from "https://unpkg.com/three@0.176.0/examples/jsm/exporters/STLExporter.js?module";
      import { mergeGeometries } from "https://unpkg.com/three@0.176.0/examples/jsm/utils/BufferGeometryUtils.js?module";

      /* make it global for the old inline code */ window.THREE = THREE;
      window.STLExporter = STLExporter;
      window.mergeGeometries = mergeGeometries;
    </script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
      <div class="max-w-4xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
        <div class="flex items-center space-x-3">
          <div
            class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center"
          >
            <svg
              class="w-5 h-5 text-white"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"
              />
            </svg>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-gray-900">
              ArUco 3D STL Generator
            </h1>
            <p class="text-sm text-gray-600">
              Generate 3D printable ArUco markers
            </p>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
      <!-- Status Card -->
      <div class="mb-8">
        <div
          id="status"
          class="bg-yellow-50 border border-yellow-200 rounded-lg p-4"
        >
          <div class="flex items-center">
            <svg
              class="animate-spin h-5 w-5 text-yellow-600 mr-3"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
            <span class="text-yellow-800 font-medium"
              >OpenCV.js is loading...</span
            >
          </div>
        </div>
      </div>

      <!-- Configuration Form -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">
            Marker Configuration
          </h2>
          <p class="text-sm text-gray-600 mt-1">
            Configure your ArUco marker settings
          </p>
        </div>

        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Dictionary Selection -->
            <div class="space-y-2">
              <label for="dict" class="block text-sm font-medium text-gray-700">
                Dictionary Type
              </label>
              <select
                id="dict"
                class="block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              >
                <option value="0">DICT_4X4_50</option>
                <option value="1">DICT_4X4_100</option>
                <option value="2">DICT_4X4_250</option>
                <option value="3">DICT_4X4_1000</option>
                <option value="4">DICT_5X5_50</option>
                <option value="5">DICT_5X5_100</option>
                <option value="6">DICT_5X5_250</option>
                <option value="7">DICT_5X5_1000</option>
                <option value="8">DICT_6X6_50</option>
                <option value="9">DICT_6X6_100</option>
                <option value="10">DICT_6X6_250</option>
                <option value="11">DICT_6X6_1000</option>
                <option value="12">DICT_7X7_50</option>
                <option value="13">DICT_7X7_100</option>
                <option value="14">DICT_7X7_250</option>
                <option value="15">DICT_7X7_1000</option>
              </select>
            </div>

            <!-- Marker ID -->
            <div class="space-y-2">
              <label
                for="markerId"
                class="block text-sm font-medium text-gray-700"
              >
                Marker ID
              </label>
              <input
                type="number"
                id="markerId"
                value="0"
                min="0"
                class="block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              />
            </div>

            <!-- Size -->
            <div class="space-y-2">
              <label
                for="sizeMm"
                class="block text-sm font-medium text-gray-700"
              >
                Size (mm)
              </label>
              <input
                type="number"
                id="sizeMm"
                value="50"
                min="1"
                class="block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              />
            </div>

            <!-- Base Thickness -->
            <div class="space-y-2">
              <label
                for="baseThick"
                class="block text-sm font-medium text-gray-700"
              >
                Base Thickness (mm)
              </label>
              <input
                type="number"
                id="baseThick"
                value="1.0"
                step="0.1"
                class="block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              />
            </div>

            <!-- Protrusion -->
            <div class="space-y-2">
              <label
                for="protrusion"
                class="block text-sm font-medium text-gray-700"
              >
                Protrusion (mm)
              </label>
              <input
                type="number"
                id="protrusion"
                value="0.4"
                step="0.1"
                class="block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              />            </div>

            <!-- Border Size -->
            <div class="space-y-2">
              <label
                for="borderSize"
                class="block text-sm font-medium text-gray-700"
              >
                Border Size (mm)
              </label>
              <input
                type="number"
                id="borderSize"
                value="5.0"
                step="0.1"
                min="0"
                class="block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              />
              <p class="text-xs text-gray-500">Extra white border around the marker</p>
            </div>
          </div>

          <!-- Generate Button -->
          <div class="mt-8">
            <button
              id="generate"
              disabled
              class="w-full md:w-auto px-6 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-medium rounded-lg shadow-sm transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
            >
              <span class="flex items-center justify-center space-x-2">
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                  />
                </svg>
                <span>Generate STL</span>
              </span>
            </button>
          </div>
        </div>
      </div>

      <!-- Info Section -->
      <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
        <div class="flex items-start space-x-3">
          <svg
            class="w-6 h-6 text-blue-600 mt-0.5 flex-shrink-0"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              fill-rule="evenodd"
              d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
              clip-rule="evenodd"
            />
          </svg>
          <div>
            <h3 class="text-sm font-medium text-blue-900">
              About ArUco Markers
            </h3>
            <div class="mt-2 text-sm text-blue-800">
              <p>
                ArUco markers are square fiducial markers used for camera pose
                estimation and object tracking. This tool generates 3D printable
                versions with raised patterns for tactile applications.
              </p>
              <ul class="mt-2 space-y-1 list-disc list-inside">
                <li>Optimized geometry creates minimal file sizes</li>
                <li>Perfect for 3D printing and embedded applications</li>
                <li>
                  Maintains marker detectability in computer vision systems
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script type="text/javascript">
      // Module configuration for OpenCV.js
      var Module = {
        onRuntimeInitialized() {
          console.log("OpenCV.js is ready.");
          const statusElement = document.getElementById("status");
          statusElement.innerHTML = `
            <div class="flex items-center">
              <svg class="h-5 w-5 text-green-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              <span class="text-green-800 font-medium">OpenCV.js is ready! You can now generate STL files.</span>
            </div>
          `;
          statusElement.className =
            "bg-green-50 border border-green-200 rounded-lg p-4";
          document.getElementById("generate").disabled = false;
        },
      };

      document
        .getElementById("generate")
        .addEventListener("click", async () => {
          // Update status to show generation in progress
          const statusElement = document.getElementById("status");
          statusElement.innerHTML = `
            <div class="flex items-center">
              <svg class="animate-spin h-5 w-5 text-blue-600 mr-3" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span class="text-blue-800 font-medium">Generating STL file...</span>
            </div>
          `;
          statusElement.className =
            "bg-blue-50 border border-blue-200 rounded-lg p-4";

          // Ensure cv is available (handle Promise if needed)
          const cvReady = cv instanceof Promise ? await cv : cv;

          if (!cvReady) {
            alert("OpenCV is not ready yet. Please wait.");
            return;
          }
          try {
            const dictSel = parseInt(document.getElementById("dict").value);
            const markerId = parseInt(
              document.getElementById("markerId").value
            );
            const sizeMm = parseFloat(document.getElementById("sizeMm").value);
            const baseThick = parseFloat(
              document.getElementById("baseThick").value
            );            const protrusion = parseFloat(
              document.getElementById("protrusion").value
            );
            const borderSize = parseFloat(
              document.getElementById("borderSize").value
            );// Function to get the actual ArUco marker size based on dictionary
            function getDictionarySize(dictIndex) {
              // ArUco dictionary sizes: 4x4, 5x5, 6x6, 7x7
              if (dictIndex >= 0 && dictIndex <= 3) return 6; // DICT_4X4_*
              if (dictIndex >= 4 && dictIndex <= 7) return 7; // DICT_5X5_*
              if (dictIndex >= 8 && dictIndex <= 11) return 8; // DICT_6X6_*
              if (dictIndex >= 12 && dictIndex <= 15) return 9; // DICT_7X7_*
              return 6; // Default fallback
            }

            // Get predefined ArUco dictionary correctly
            const dictionary = cvReady.getPredefinedDictionary(dictSel);

            // Generate at reasonable resolution to get clear bit pattern
            const markerSize = getDictionarySize(dictSel); // Get the actual marker size (e.g., 6x6)
            const renderSize = markerSize * 10; // Render at 10px per bit for clarity
            const markerImg = new cvReady.Mat();

            try {
              dictionary.generateImageMarker(
                markerId,
                renderSize,
                markerImg,
                1
              );
            } catch (openCvError) {
              markerImg.delete();
              throw new Error(
                `OpenCV error generating marker: ${openCvError}. Check that marker ID ${markerId} exists in the selected dictionary.`
              );
            }

            const cols = markerImg.cols;
            const rows = markerImg.rows;

            // Sample the image to get the bit pattern
            const bitMatrix = Array.from({ length: markerSize }, () =>
              Array(markerSize).fill(0)
            );

            const sampleSize = renderSize / markerSize;
            for (let y = 0; y < markerSize; y++) {
              for (let x = 0; x < markerSize; x++) {
                // Sample from the center of each bit
                const sampleY = Math.floor(y * sampleSize + sampleSize / 2);
                const sampleX = Math.floor(x * sampleSize + sampleSize / 2);
                bitMatrix[y][x] =
                  markerImg.ucharPtr(sampleY, sampleX)[0] < 128 ? 1 : 0;
              }
            }
            markerImg.delete(); // Important: free memory            // Build 3D model - work with actual ArUco bit structure
            const scene = new THREE.Scene();
            const unit = sizeMm / markerSize; // Each "bit" of the ArUco marker

            // Create base with border expansion
            const totalSize = sizeMm + (borderSize * 2); // Add border on all sides
            const baseGeom = new THREE.BoxGeometry(totalSize, totalSize, baseThick);
            baseGeom.translate(totalSize / 2, totalSize / 2, baseThick / 2);

            // Collect geometries for merging
            const geometries = [baseGeom];            // Create protrusions for black bits (now working with actual ArUco structure)
            bitMatrix.forEach((row, y) => {
              row.forEach((bit, x) => {
                if (bit === 1) {
                  const box = new THREE.BoxGeometry(unit, unit, protrusion);
                  box.translate(
                    borderSize + (x + 0.5) * unit, // Offset by border size
                    borderSize + (markerSize - y - 0.5) * unit, // Offset by border size
                    baseThick + protrusion / 2
                  );
                  geometries.push(box);
                }
              });
            });

            // Merge all geometries
            const finalGeometry = mergeGeometries(geometries);
            const mesh = new THREE.Mesh(finalGeometry);
            scene.add(mesh);

            // Export as STL
            const exporter = new STLExporter();
            const stlString = exporter.parse(scene);
            const blob = new Blob([stlString], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `aruco_${dictSel}_${markerId}.stl`;
            a.click();
            URL.revokeObjectURL(url);

            // Update status to show success
            statusElement.innerHTML = `
              <div class="flex items-center">
                <svg class="h-5 w-5 text-green-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <span class="text-green-800 font-medium">STL file generated successfully! Download should start automatically.</span>
              </div>
            `;
            statusElement.className =
              "bg-green-50 border border-green-200 rounded-lg p-4";
          } catch (error) {
            console.error("Error generating STL:", error);

            // Update status to show error
            statusElement.innerHTML = `
              <div class="flex items-center">
                <svg class="h-5 w-5 text-red-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <span class="text-red-800 font-medium">Error: ${error.message}</span>
              </div>
            `;
            statusElement.className =
              "bg-red-50 border border-red-200 rounded-lg p-4";

            alert("Error generating STL: " + error.message);
          }
        });
    </script>
    <script async src="opencv.js" type="text/javascript"></script>
  </body>
</html>
